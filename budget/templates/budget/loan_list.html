{% extends 'budget/base.html' %}
{% block title %}My Loans{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  
  <!-- Page Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
    <div>
      <hr class="mb-0" style="border: none;">
      <h2 class="mb-1"><i class="bi bi-bank me-2"></i>My Loans</h2>
      <p class="text-muted mb-2">Track all your active loans and repayments.</p>
      <a href="{% url 'create_loan' %}" class="btn btn-sm btn-outline-success mt-2">+ Open Loan Account</a>
    </div>

    <div class="mt-3 mt-md-0 text-md-end">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  <!-- Loans Tabs -->
  <ul class="nav nav-pills gap-2 mb-4" id="loan-tab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active bg-white shadow-sm border fw-semibold text-dark rounded-pill px-3 py-2 d-flex align-items-center gap-2"
              data-bs-toggle="pill"
              data-bs-target="#loan-accounts"
              type="button"
              role="tab">
        <i class="bi bi-bank"></i> Loan Accounts
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link bg-light text-muted rounded-pill px-3 py-2 d-flex align-items-center gap-2"
              data-bs-toggle="pill"
              data-bs-target="#loan-transactions"
              type="button"
              role="tab">
        <i class="bi bi-list-ul"></i> Repayment History
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">

    <!-- Loan Accounts -->
    <div class="tab-pane fade show active" id="loan-accounts" role="tabpanel">
      {% if loans %}
      <div class="row g-4">
        {% for loan in loans %}
        <div class="col-12 col-md-6 col-lg-4 d-flex">
          <div class="card shadow-sm h-100 border-0 rounded-4 bg-success-subtle w-100">
            <div class="card-body d-flex flex-column">
              <div class="mb-3">
                <h5 class="card-title mb-2 fw-bold text-dark">{{ loan.name }}</h5>
                <p class="mb-1"><i class="bi bi-cash-stack me-1"></i> <strong>Loan Amount:</strong> KES {{ loan.principal|floatformat:2 }}</p>
                <p class="mb-1"><i class="bi bi-percent me-1"></i> <strong>Interest Rate:</strong> {{ loan.annual_interest_rate }}%</p>
                <p class="mb-1"><i class="bi bi-wallet2 me-1"></i> <strong>Pending Principal Pay:</strong> KES {{ loan.remaining_balance|floatformat:2 }}</p>
                <p class="mb-1"><i class="bi bi-calendar-event me-1"></i> <strong>First Payment Date:</strong> {{ loan.start_date }}</p>
                <p class="mb-1"><i class="bi bi-clock me-1"></i> <strong>Payment Frequency:</strong> {{ loan.payment_frequency }} ({{ loan.term_periods }} Payments)</p>
              </div>

              <hr class="my-3">

              <!-- Actions -->
              <div class="d-flex justify-content-between">
                <a href="{% url 'loan_detail' loan.id %}" class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1">
                  <i class="bi bi-eye"></i> View
                </a>

                {% if loan.remaining_balance > 0 %}
                  <a href="{% url 'add_loan_payment' loan.id %}" class="btn btn-primary btn-sm d-flex align-items-center gap-1">
                    <i class="bi bi-plus-circle"></i> Add Payment
                  </a>
                {% else %}
                  <button class="btn btn-secondary btn-sm d-flex align-items-center gap-1" disabled>
                    <i class="bi bi-check-circle"></i> Paid
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-info-circle fs-3 mb-2 d-block"></i>
          <p class="mb-0 fs-5">No loans yet. <a href="{% url 'create_loan' %}">Record one now</a>.</p>
        </div>
      {% endif %}
    </div>

    <!-- Loan Transactions -->
    <div class="tab-pane fade" id="loan-transactions" role="tabpanel">
      <div class="container-fluid px-3">
        {% if loan_data %}
          <div class="d-flex flex-wrap gap-2 mb-4">
            {% for data in loan_data %}
              <button type="button"
                      class="btn btn-outline-secondary rounded-pill px-4 py-2 border-0 loan-transaction-btn {% if forloop.first %}active{% endif %}"
                      data-target="#loan-{{ forloop.counter }}">
                {{ data.loan.name }}
              </button>
            {% endfor %}
          </div>

          {% for data in loan_data %}
          <div class="loan-report {% if not forloop.first %}d-none{% endif %}" id="loan-{{ forloop.counter }}">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover small align-middle">
                  <thead class="table-light">
                    <tr class="align-middle text-nowrap">
                      <th>Date</th>
                      <th>Wallet</th>
                      <th>Description</th>
                      <th>Amount (KES)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for t in data.transactions %}
                      <tr style="line-height: 1.6;">
                        <td>{{ t.date|date:"M d, Y" }}</td>
                        <td>{{ t.source }}</td>
                        <td>{{ t.description }}</td>
                        <td>
                          <span class="text-danger fw-bold">KES {{ t.amount|floatformat:2 }}</span>
                        </td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="4" class="text-center text-muted py-3">No payments recorded yet.</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- JS for loan transaction tab switching -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const loanButtons = document.querySelectorAll(".loan-transaction-btn");
  const reports = document.querySelectorAll(".loan-report");

  loanButtons.forEach(btn => {
    btn.addEventListener("click", function () {
      loanButtons.forEach(b => b.classList.remove("active"));
      reports.forEach(r => r.classList.add("d-none"));

      this.classList.add("active");
      const target = document.querySelector(this.dataset.target);
      if (target) target.classList.remove("d-none");
    });
  });

  const transactionsTab = document.querySelector('[data-bs-target="#loan-transactions"]');
  transactionsTab.addEventListener('shown.bs.tab', function () {
    if (loanButtons.length > 0) {
      loanButtons[0].click();
    }
  });
});
</script>

<!-- JS to style active loan pills -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loanTabs = document.querySelectorAll('#loan-tab .nav-link');

    function applyLoanTabStyles() {
      loanTabs.forEach(btn => {
        btn.classList.remove('bg-white', 'text-dark', 'fw-semibold', 'border', 'border-dark', 'bg-light', 'text-muted');
        if (btn.classList.contains('active')) {
          btn.classList.add('bg-white', 'text-dark', 'fw-semibold', 'border', 'border-dark');
        } else {
          btn.classList.add('bg-light', 'text-muted');
        }
      });
    }

    // Initial setup
    applyLoanTabStyles();

    // Update on click
    loanTabs.forEach(btn => {
      btn.addEventListener('click', applyLoanTabStyles);
    });
  });
</script>


<!--<div class="container-fluid mt-4">-->
  
  <!-- Page Header -->
<!--  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">-->
<!--    <div>-->
<!--      <hr class="mb-0" style="border: none;">-->
<!--      <h2 class="mb-1"><i class="bi bi-bank me-2"></i>My Loans</h2>-->
<!--      <p class="text-muted mb-2">Track all your active loans and repayments.</p>-->
<!--      <a href="{% url 'create_loan' %}" class="btn btn-sm btn-outline-success mt-2">+ Open Loan Account</a>-->
<!--    </div>-->

<!--    <div class="mt-3 mt-md-0 text-md-end">-->
<!--      {% if messages %}-->
<!--        {% for message in messages %}-->
<!--          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">-->
<!--            {{ message }}-->
<!--            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>-->
<!--          </div>-->
<!--        {% endfor %}-->
<!--      {% endif %}-->
<!--    </div>-->
<!--  </div>-->

<!--{% if loans %} -->
<!--<div class="row g-4">-->
<!--  {% for loan in loans %}-->
<!--  <div class="col-12 col-md-6 col-lg-4 d-flex">-->
<!--    <div class="card shadow-sm h-100 border-0 rounded-4 bg-success-subtle w-100">-->
<!--      <div class="card-body d-flex flex-column">-->

        <!-- Loan Info -->
<!--        <div class="mb-3">-->
<!--          <h5 class="card-title mb-2 fw-bold text-dark">-->
<!--            {{ loan.name }}-->
<!--          </h5>-->
<!--          <p class="mb-1"><i class="bi bi-cash-stack me-1"></i> <strong>Loan Amount:</strong> KES {{ loan.principal|floatformat:2 }}</p>-->
<!--          <p class="mb-1"><i class="bi bi-percent me-1"></i> <strong>Interest Rate:</strong> {{ loan.annual_interest_rate }}%</p>-->
<!--          <p class="mb-1"><i class="bi bi-wallet2 me-1"></i> <strong>Pending Principal Pay:</strong> KES {{ loan.remaining_balance|floatformat:2 }}</p>-->
<!--          <p class="mb-1"><i class="bi bi-calendar-event me-1"></i> <strong>First Payment Date:</strong> {{ loan.start_date }}</p>-->
<!--          <p class="mb-1"><i class="bi bi-clock me-1"></i> <strong>Payment Frequency:</strong> {{ loan.payment_frequency }} ({{ loan.term_periods }} Payments) </p>-->
<!--        </div>-->

        <!-- Divider -->
<!--        <hr class="my-3">-->

<!-- Actions -->
<!--<div class="d-flex justify-content-between">-->
<!--  <a href="{% url 'loan_detail' loan.id %}" class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1">-->
<!--    <i class="bi bi-eye"></i>View-->
<!--  </a>-->

<!--  {% if loan.remaining_balance > 0 %}-->
<!--    <a href="{% url 'add_loan_payment' loan.id %}" class="btn btn-primary btn-sm d-flex align-items-center gap-1">-->
<!--      <i class="bi bi-plus-circle"></i>Add Payment-->
<!--    </a>-->
<!--  {% else %}-->
<!--    <button class="btn btn-secondary btn-sm d-flex align-items-center gap-1" disabled>-->
<!--      <i class="bi bi-check-circle"></i> Paid-->
<!--    </button>-->
<!--  {% endif %}-->
<!--</div>-->


<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--  {% endfor %}-->
<!--</div>-->
<!--{% else %}-->
<!--<div class="text-center text-muted py-5">-->
<!--  <i class="bi bi-info-circle fs-3 mb-2 d-block"></i>-->
<!--  <p class="mb-0 fs-5">No loans yet. <a href="{% url 'create_loan' %}">Record one now</a>.</p>-->
<!--</div>-->
<!--{% endif %}-->



<!--</div>-->

{% endblock %}
