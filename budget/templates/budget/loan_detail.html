{% extends 'budget/base.html' %}

{% block title %}Loan Payoff Stimulator{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

<!-- Loan Header with Popover -->
<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
  <div class="d-flex align-items-center mb-2">
    <h3 class="mb-0 me-2"><i class="bi bi-bank me-1"></i>{{ loan.name }}</h3>

    <!-- Popover Info Button -->
    <button type="button" class="btn btn-sm btn-outline-secondary p-0"
            tabindex="0"
            data-bs-toggle="popover"
            data-bs-trigger="focus"
            data-bs-placement="right"
            data-bs-html="true"
            title="Loan Overview"
            data-bs-content="
              <ul style='padding-left: 1rem; margin-bottom: 0;'>
                <li>Track your active loans, see how much is left to pay, and check your interest rates.</li>
                <li>The chart shows your loan balance over time and how extra payments can speed up repayment.</li>
                <li>Try extra payments in the simulator to see how your loan timeline shortens and how much interest you can save.</li>
                <li><strong>Periods</strong> represent each payment instance - monthly, weekly, annually.</li>
              </ul>
            ">
      <i class="bi bi-question-circle fs-4"></i>
    </button>
  </div>

  <div class="mt-3 mt-md-0 text-md-end">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  </div>    

{% if loan.remaining_balance > 0 %}
  <a href="{% url 'add_loan_payment' loan.id %}" class="btn btn-primary d-flex align-items-center gap-1">
    <i class="bi bi-plus-circle"></i> Add Payment
  </a>
{% else %}
  <button class="btn btn-secondary d-flex align-items-center gap-1" disabled>
    <i class="bi bi-check-circle"></i> Fully Paid
  </button>
{% endif %}


  <!--<a href="{% url 'add_loan_payment' loan.id %}" class="btn btn-primary btn-sm mb-2 d-flex align-items-center gap-1">-->
  <!--  <i class="bi bi-plus-circle"></i> Add Payment-->
  <!--</a>-->
  
</div>



<div class="row g-3">
  <!-- Chart & Simulation Results -->
  <div class="col-12 col-md-9 d-flex flex-column gap-3">
    
    <!-- Chart -->
    <div class="mb-0 d-flex flex-column flex-grow-1">
      <h5 class="mb-2"><i class="bi bi-graph-up me-1"></i>Loan Payoff Chart</h5>
      <div style="flex-grow:1; min-height:300px;">
        <canvas id="loanChart" style="width:100%; height:100%;"></canvas>
      </div>
    </div>

    <!-- Simulation Results -->
    {% if extra_per_period or one_time_extra %}
    <div class="alert alert-info mb-0">
      <h6 class="fw-bold mb-2"><i class="bi bi-bar-chart-line me-1"></i>Simulation Results</h6>
      <p class="mb-1"><strong>Interest Saved:</strong> KES {{ interest_saved|floatformat:2 }}</p>
      <p class="mb-1"><strong>Time Saved:</strong> {{ time_saved_str }}</p>
      <p class="mb-1"><strong>Current Balance:</strong> KES {{ current_balance|floatformat:2 }}</p>
      <p class="mb-0"><strong>New Projected Balance:</strong> KES {{ projected_balance_now|floatformat:2 }}</p>
    </div>
    {% endif %}

  </div>

  <!-- Loan Summary & Simulation Form -->
  <div class="col-12 col-md-3 d-flex flex-column gap-3">
    <!-- Loan Summary -->
    <div class="p-3 border rounded bg-light">
      <h6 class="mb-2"><i class="bi bi-wallet2 me-1"></i>Loan Summary</h6>
      <p class="mb-1"><strong>Original Loan Amount:</strong> KES {{ loan.principal|floatformat:2 }}</p>
      <p class="mb-1"><strong>Remaining Principal Amount:</strong> KES {{ loan.remaining_balance|floatformat:2 }}</p>
      <p class="mb-0"><strong>Remaining Payments:</strong> {{ remaining_payments }}</p>
      <small class="text-muted">Based on completed installments and original schedule.</small>
    </div>

    <!-- Payoff Simulation Form -->
    <div class="p-3 border rounded bg-light">
      <h6 class="mb-3"><i class="bi bi-lightning-charge me-1"></i>Try a Payoff Simulation</h6>
      <form method="get">
        <div class="mb-3">
          <label for="extra_per_period" class="form-label">Extra Payment (Per Period)</label>
          <input type="number" step="0.01" id="extra_per_period" name="extra_per_period"
                 class="form-control" placeholder="e.g. 50.00" value="{{ extra_per_period }}">
          <small class="text-muted">Add this amount to your regular payment for each period, e.g., 1000 more for each payment.</small>
        </div>

        <div class="mb-3">
          <label for="one_time_extra" class="form-label">One-Time Extra Payment</label>
          <input type="number" step="0.01" id="one_time_extra" name="one_time_extra"
                 class="form-control" placeholder="e.g. 200.00" value="{{ one_time_extra }}">
          <small class="text-muted">A single extra payment to reduce your balance faster, e.g., 20,000 above your regular payments.</small>
        </div>

        <div class="mb-3">
          <label for="start_extra_period" class="form-label">Start Extra Payments From Period #</label>
          <input type="number" id="start_extra_period" name="start_extra_period"
                 class="form-control" placeholder="e.g. 5" value="{{ start_extra_period }}">
          <small class="text-muted">Enter the period number when extra payment(s) should begin, e.g., 1 for first payment.</small>
        </div>

        <button type="submit" class="btn btn-success w-100 mt-2 d-flex align-items-center justify-content-center gap-1">
          <i class="bi bi-play-circle"></i> Run Simulation
        </button>
      </form>
    </div>
  </div>
</div>


  <hr class="my-4">

  <!-- Amortization Schedule -->
<h5 class="mb-1"><i class="bi bi-calendar-check me-1"></i>Loan Payoff Timeline</h5>
<small class="text-muted">See how your payments and extra contributions affect your remaining balance.</small>

  <div class="table-responsive">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Period</th>
          <th>Payment</th>
          <th>Interest</th>
          <th>Principal</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody>
        {% for row in sim_schedule %}
        <tr>
          <td>{{ row.period }}</td>
          <td>{{ row.payment }}</td>
          <td>{{ row.interest }}</td>
          <td>{{ row.principal }}</td>
          <td>{{ row.balance }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<div class="d-flex justify-content-between mt-3">
  <!-- Back Button -->
  <a href="{% url 'loan_list' %}" class="btn btn-secondary btn-sm d-flex align-items-center gap-1">
    <i class="bi bi-arrow-left"></i> Back
  </a>

  <!-- Delete Loan -->
  <form method="post" action="{% url 'loan_delete' loan.pk %}" 
        onsubmit="return confirm('Are you sure you want to delete this loan?');">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger btn-sm d-flex align-items-center gap-1">
      <i class="bi bi-trash"></i> Delete Loan
    </button>
  </form>
</div>


</div>

<!-- Chart Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const originalSchedule = {{ schedule|safe }};
const simulatedSchedule = {{ sim_schedule|safe }};
const payments = {{ payments|safe }};
const labels = originalSchedule.map(r => r.period);

let balance = {{ loan.principal }};
let actualTrack = [];
let paymentIndex = 0;

for (let i = 0; i < labels.length; i++) {
    let periodPayment = 0;
    if (paymentIndex < payments.length && payments[paymentIndex].period == labels[i]) {
        periodPayment = payments[paymentIndex].amount;
        paymentIndex++;
    }
    balance -= periodPayment;
    actualTrack.push(balance > 0 ? balance : 0);
}

new Chart(document.getElementById('loanChart'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            { label: 'Actual Payments', data: actualTrack, borderColor: 'green', fill: false, tension: 0.1 },
            { label: 'Original Schedule', data: originalSchedule.map(r => r.balance), borderColor: 'blue', borderDash: [5,5], fill: false, tension: 0.1 },
            { label: 'Simulation', data: simulatedSchedule.map(r => r.balance), borderColor: 'red', borderDash: [5,5], fill: false, tension: 0.1 }
        ]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
        interaction: { mode: 'nearest', axis: 'x', intersect: false },
        scales: { y: { beginAtZero: true, title: { display: true, text: 'Loan Balance (KES)' } },
                  x: { title: { display: true, text: 'Period' } } }
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
  var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl);
  });
});
</script>

{% endblock %}
