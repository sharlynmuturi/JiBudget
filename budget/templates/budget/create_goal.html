{% extends 'budget/base.html' %}

{% block title %}
  {% if editing %}Edit{% else %}Create{% endif %} Jar
{% endblock %}

{% block content %}
<div class="container-fluid section-spacing px-0">
  <div class="row">
    <div class="col-md-5">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom d-flex align-items-center">
          <i class="bi bi-piggy-bank fs-4 me-2 text-primary"></i>
          <h5 class="mb-0 fw-semibold">
            {% if editing %}Top Up Savings Jar{% else %}Create Savings Jar{% endif %}
          </h5>
          
          <!-- Info icon with popover pushed right -->
          <button type="button" class="btn btn-sm btn-outline-secondary ms-auto p-0" 
                  tabindex="0"
                  data-bs-toggle="popover" 
                  data-bs-trigger="focus" 
                  data-bs-placement="left" 
                  data-bs-html="true"
                  title="Start Setting Money Aside"
                  data-bs-content="
                    <ul style='padding-left: 1rem; margin-bottom: 0;'>
                      <li>Create a jar, name your goal and set a target amount.</li>
                      <li>Add savings to the jar, specifying the amount and which wallet to take out funds for saving.</li>
                      <li>Top up your jar regularly to keep saving toward your goal, track your progress or withdraw from jar in the savings page.</li>
                    </ul>
                  ">
            <i class="bi bi-question-circle fs-4"></i>
          </button>
          
        </div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}

          {% if editing %}
          <div class="bg-light rounded p-3 mb-3">
            <h6 class="text-muted mb-2">Jar Summary</h6>
            <p><strong>{{ goal.subcategory }}</strong></p>
            <p class="text-muted mb-1">Target: <strong>KES {{ goal.target_amount|floatformat:2 }}</strong></p>
            <p class="text-muted mb-1">Saved so far: <strong>KES {{ goal.saved_so_far|floatformat:2 }}</strong></p>
            {% if goal.deadline %}
            <p class="text-muted mb-2">Date Created: {{ goal.created_at|date:"M d, Y" }}</p>
            {% endif %}
            <span class="badge bg-info text-dark mb-3">Progress: {{ goal.progress|floatformat:1 }}%</span>
          </div>

        <form method="post" action="">
          {% csrf_token %}
          <input type="hidden" name="add_to_goal" value="1">
        
          <div class="mb-3">
            <label for="amount" class="form-label">Add to Jar (KES)</label>
            <input type="number" name="amount" step="0.01" class="form-control" placeholder="e.g. 500" required>
          </div>
        
        <div class="input-group mb-3">
          <select name="source_id" id="id_source_id" class="form-select" required>
            <option value="">Select Wallet to Deposit from</option>
            {% for source in wallets %}
              <option value="{{ source.id }}">{{ source.name }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#addWalletModal">
            +
          </button>
        </div>
        
          <div class="d-flex justify-content-between align-items-center">
            <button type="submit" class="btn btn-outline-primary">Top Up Savings</button>
            <a href="{% url 'saving_list' %}" class="btn btn-outline-secondary">Back</a>
          </div>
        </form>

          {% else %}
        <form method="post" action="">
          {% csrf_token %}
        
          <div class="bg-light rounded p-3 mb-3">
            <h6 class="text-muted mb-2">Savings Goal Info</h6>
        
            <div class="mb-3">
              <label for="id_subcategory" class="form-label">Goal Item</label>
              <div class="input-group">
                {{ form.subcategory }}
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addSubcategoryModal">+</button>
              </div>
            </div>
        
            <div class="mb-3">
              <label for="id_target_amount" class="form-label">Target Amount (KES)</label>
              {{ form.target_amount }}
            </div>
        
            <div class="mb-3">
              <label for="id_saved_so_far" class="form-label">Initial Deposit (KES)</label>
              {{ form.saved_so_far }}
            </div>
        
            <div class="mb-3">
              <label for="id_source" class="form-label">Wallet for Initial Deposit</label>
              <div class="input-group">
              {{ form.source }}
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addWalletModal">+</button>
            </div>
          </div>
        
          <div class="d-flex justify-content-between align-items-center">
            <button type="submit" class="btn btn-success">Save Goal</button>
            <a href="{% url 'saving_list' %}" class="btn btn-outline-secondary">Back</a>
          </div>
        </form>

          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal to Add New Subcategory -->
<div class="modal fade" id="addSubcategoryModal" tabindex="-1" aria-labelledby="addSubcategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addSubcategoryForm" method="POST" action="{% url 'add_savings_subcategory' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addSubcategoryModalLabel">Add Savings Goal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="new_subcategory_name" class="form-label">Goal Item</label>
            <input type="text" name="name" id="new_subcategory_name" class="form-control text-muted" placeholder="e.g., Emergency Fund" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Wallet Modal -->
<div class="modal fade" id="addWalletModal" tabindex="-1" aria-labelledby="addWalletModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow">
      <form id="walletForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addWalletModalLabel">Add Wallet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="walletName" class="form-label">Wallet Name</label>
            <input type="text" class="form-control" id="walletName" name="name" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Wallet</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl)
    })
  });
</script>

<script>
document.getElementById("addSubcategoryForm").addEventListener("submit", function(event) {
  event.preventDefault();
  const name = document.getElementById("new_subcategory_name").value;

  fetch("{% url 'add_savings_subcategory' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-CSRFToken": "{{ csrf_token }}",
    },
    body: new URLSearchParams({ name })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const select = document.getElementById("id_subcategory");
      const option = document.createElement("option");
      option.value = data.id;
      option.text = data.name;
      option.selected = true;
      select.appendChild(option);

      document.getElementById("addSubcategoryForm").reset();
      var modal = bootstrap.Modal.getInstance(document.getElementById('addSubcategoryModal'));
      modal.hide();
    } else {
      alert(data.error || "Failed to add subcategory.");
    }
  });
});
</script>


<script>
document.getElementById('walletForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const name = document.getElementById('walletName').value;

  fetch("{% url 'add_expense_source' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: new URLSearchParams({ name: name }),
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const select = document.getElementById("id_source_id");
      const option = document.createElement("option");
      option.value = data.id;
      option.text = data.name;
      option.selected = true;
      select.add(option);

      document.getElementById("walletForm").reset();
      const modal = bootstrap.Modal.getInstance(document.getElementById("addWalletModal"));
      modal.hide();
    } else {
      alert(data.error || "Something went wrong.");
    }
  });
});
</script>


{% endblock %}
